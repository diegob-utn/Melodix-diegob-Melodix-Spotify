@model Melodix.MVC.ViewModels.SuscripcionViewModel
@using Melodix.Models
@using Melodix.Models.Models

@{
  ViewData["Title"] = "Mi Plan de Suscripción";
}

<div class="container-fluid py-4">
  <div class="row">
    <div class="col-lg-10 mx-auto">
      <div class="card shadow-sm">
        <div class="card-header bg-gradient" style="background: linear-gradient(135deg, var(--accent), var(--accent-dark));">
          <h4 class="mb-0 text-white">
            <i class="bi bi-star-fill me-2"></i>
            Mi Plan de Suscripción
          </h4>
        </div>
        <div class="card-body p-4">
          @if (Model.SuscripcionActual != null && Model.TieneSuscripcionActiva)
          {
            <div class="row">
              <div class="col-md-6">
                <div class="mb-4">
                  <h5 class="text-primary mb-3">
                    <i class="bi bi-crown me-2"></i>Plan Actual
                  </h5>
                  <div class="card border-primary">
                    <div class="card-body bg-light">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <h5 class="card-title text-primary fw-bold">@Model.SuscripcionActual.Plan.Nombre</h5>
                          <p class="card-text text-muted">@Model.SuscripcionActual.Plan.Descripcion</p>
                        </div>
                        <div class="text-end">
                          <h4 class="text-success mb-0">$@Model.SuscripcionActual.Plan.Precio.ToString("F2")</h4>
                          <small class="text-muted">/ mes</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-4">
                  <h5 class="text-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>Detalles de la Suscripción
                  </h5>
                  <div class="card">
                    <div class="list-group list-group-flush">
                      <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-calendar-check me-2 text-success"></i>Fecha de Inicio:</span>
                        <strong class="text-primary">@Model.SuscripcionActual.FechaInicio.ToString("dd/MM/yyyy")</strong>
                      </div>
                      @if (Model.SuscripcionActual.FechaFin.HasValue)
                      {
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                          <span><i class="bi bi-calendar-x me-2 text-warning"></i>Fecha de Vencimiento:</span>
                          <strong class="text-warning">@Model.SuscripcionActual.FechaFin.Value.ToString("dd/MM/yyyy")</strong>
                        </div>
                      }
                      else
                      {
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                          <span><i class="bi bi-infinity me-2 text-success"></i>Renovación:</span>
                          <strong class="text-success">Automática</strong>
                        </div>
                      }
                      <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-activity me-2"></i>Estado:</span>
                        <span class="badge @(Model.SuscripcionActual.Estado == EstadoSuscripcion.Activa ? "bg-success" : "bg-danger") fs-6">
                          @(Model.SuscripcionActual.Estado == EstadoSuscripcion.Activa ? "Activa" : Model.SuscripcionActual.Estado.ToString())
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <hr class="my-4">

            <div class="row">
              <div class="col-12">
                <h5 class="text-primary mb-4">
                  <i class="bi bi-gift me-2"></i>Beneficios de tu Plan Premium
                </h5>
                <div class="row g-4">
                  <div class="col-md-4">
                    <div class="text-center p-4 h-100 benefit-card">
                      <div class="benefit-icon mb-3">
                        <i class="bi bi-music-note-beamed display-4 text-primary"></i>
                      </div>
                      <h6 class="fw-bold">Música Ilimitada</h6>
                      <p class="text-muted small mb-0">Acceso completo a toda la biblioteca musical sin restricciones</p>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="text-center p-4 h-100 benefit-card">
                      <div class="benefit-icon mb-3">
                        <i class="bi bi-download display-4 text-success"></i>
                      </div>
                      <h6 class="fw-bold">Descargas Offline</h6>
                      <p class="text-muted small mb-0">Descarga y escucha tu música favorita sin conexión a internet</p>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="text-center p-4 h-100 benefit-card">
                      <div class="benefit-icon mb-3">
                        <i class="bi bi-volume-up display-4 text-warning"></i>
                      </div>
                      <h6 class="fw-bold">Alta Calidad</h6>
                      <p class="text-muted small mb-0">Streaming de audio en máxima calidad para la mejor experiencia</p>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="text-center p-4 h-100 benefit-card">
                      <div class="benefit-icon mb-3">
                        <i class="bi bi-x-circle display-4 text-danger"></i>
                      </div>
                      <h6 class="fw-bold">Sin Anuncios</h6>
                      <p class="text-muted small mb-0">Disfruta de tu música sin interrupciones publicitarias</p>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="text-center p-4 h-100 benefit-card">
                      <div class="benefit-icon mb-3">
                        <i class="bi bi-skip-forward display-4 text-info"></i>
                      </div>
                      <h6 class="fw-bold">Saltos Ilimitados</h6>
                      <p class="text-muted small mb-0">Cambia de canción tantas veces como quieras</p>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="text-center p-4 h-100 benefit-card">
                      <div class="benefit-icon mb-3">
                        <i class="bi bi-people display-4 text-purple"></i>
                      </div>
                      <h6 class="fw-bold">Listas Colaborativas</h6>
                      <p class="text-muted small mb-0">Crea y comparte listas de reproducción con amigos</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <hr class="my-4">

            <div class="text-center">
              <div class="btn-group" role="group">
                <a href="@Url.Action("Planes", "Suscripcion")" class="btn btn-outline-primary btn-lg me-2">
                  <i class="bi bi-arrow-up-circle me-2"></i>
                  Cambiar Plan
                </a>
                <button type="button" class="btn btn-outline-danger btn-lg" onclick="confirmarCancelacion()">
                  <i class="bi bi-x-circle me-2"></i>
                  Cancelar Suscripción
                </button>
              </div>
              <div class="mt-3">
                <small class="text-muted">
                  <i class="bi bi-shield-check me-1"></i>
                  Tu suscripción se renovará automáticamente. Puedes cancelar en cualquier momento.
                </small>
              </div>
            </div>
          }
          else
          {
            <div class="text-center py-5">
              <div class="mb-4">
                <i class="bi bi-music-note-list display-1 text-muted opacity-50"></i>
              </div>
              <h3 class="text-primary mb-3">No tienes un plan activo</h3>
              <p class="text-muted mb-4 fs-5">
                Desbloquea todo el potencial de Melodix con una suscripción premium.<br>
                Disfruta de música sin límites, descargas offline y mucho más.
              </p>
              
              <div class="row justify-content-center mb-4">
                <div class="col-md-8">
                  <div class="row text-center">
                    <div class="col-4">
                      <i class="bi bi-music-note-beamed display-6 text-primary"></i>
                      <p class="small text-muted mt-2">Música Ilimitada</p>
                    </div>
                    <div class="col-4">
                      <i class="bi bi-download display-6 text-success"></i>
                      <p class="small text-muted mt-2">Descargas Offline</p>
                    </div>
                    <div class="col-4">
                      <i class="bi bi-volume-up display-6 text-warning"></i>
                      <p class="small text-muted mt-2">Alta Calidad</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <a href="@Url.Action("Planes", "Suscripcion")" class="btn btn-primary btn-lg px-5">
                <i class="bi bi-star me-2"></i>
                Ver Planes Disponibles
              </a>
            </div>
          }
          
          @if (ViewBag.HistorialTransacciones != null)
          {
            var transacciones = ViewBag.HistorialTransacciones as List<TransaccionPago>;
            if (transacciones != null && transacciones.Any())
            {
              <hr class="my-4">
              <div class="row">
                <div class="col-12">
                  <h5 class="text-secondary mb-3">
                    <i class="bi bi-receipt me-2"></i>Historial de Pagos
                  </h5>
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead class="table-light">
                        <tr>
                          <th>Fecha</th>
                          <th>Descripción</th>
                          <th>Monto</th>
                          <th>Estado</th>
                        </tr>
                      </thead>
                      <tbody>
                        @foreach (var transaccion in transacciones.Take(5))
                        {
                          <tr>
                            <td>@transaccion.Fecha.ToString("dd/MM/yyyy")</td>
                            <td>@(transaccion.Detalle ?? "Pago de suscripción")</td>
                            <td class="text-success fw-bold">$@transaccion.Monto.ToString("F2")</td>
                            <td>
                              <span class="badge @(transaccion.Estado == EstadoPago.Exitoso ? "bg-success" : transaccion.Estado == EstadoPago.Pendiente ? "bg-warning" : "bg-danger")">
                                @transaccion.Estado.ToString()
                              </span>
                            </td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            }
          }
        </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
  <script>
    function confirmarCancelacion() {
      Swal.fire({
        title: '¿Cancelar suscripción?',
        text: 'Perderás acceso a todas las funcionalidades premium. Esta acción no se puede deshacer.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, cancelar',
        cancelButtonText: 'No, mantener'
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = '@Url.Action("CancelarSuscripcion", "Suscripcion")';
        }
      });
    }
  </script>
}

@section Styles {
  <style>
    .benefit-card {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      transition: all 0.3s ease;
    }
    
    .benefit-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border-color: var(--accent);
    }
    
    .benefit-icon {
      transition: transform 0.3s ease;
    }
    
    .benefit-card:hover .benefit-icon {
      transform: scale(1.1);
    }
    
    .text-purple {
      color: #6f42c1 !important;
    }
    
    .bg-gradient {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark)) !important;
    }
    
    .btn-lg {
      padding: 12px 30px;
      font-size: 1.1rem;
    }
    
    .card {
      border: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .list-group-item {
      border-left: none;
      border-right: none;
    }
    
    .list-group-item:first-child {
      border-top: none;
    }
    
    .list-group-item:last-child {
      border-bottom: none;
    }
  </style>
}
